#if 0
	shc Version 4.0.1, Generic Shell Script Compiler
	GNU GPL Version 3 Md Jahidul Hamid <jahidulhamid@yahoo.com>

	shc -r -f task_12 
#endif

static  char data [] = 
#define      msg2_z	19
#define      msg2	((&data[3]))
	"\105\013\340\047\062\220\271\137\006\221\244\226\147\321\311\171"
	"\215\133\057\005\220\016\021\101"
#define      pswd_z	256
#define      pswd	((&data[61]))
	"\245\202\300\150\045\236\313\026\203\123\350\043\117\306\345\074"
	"\212\051\315\353\307\173\137\014\206\077\036\307\107\262\137\355"
	"\065\037\125\132\276\340\107\227\156\317\237\226\342\223\112\254"
	"\152\271\034\262\366\162\077\276\003\070\155\303\276\077\054\143"
	"\107\335\101\315\275\210\144\053\127\004\302\072\227\014\346\002"
	"\305\003\264\274\166\364\172\171\055\347\075\354\047\151\120\157"
	"\106\221\074\004\032\240\057\161\245\361\254\074\376\223\077\304"
	"\226\364\200\015\350\372\207\026\342\304\002\012\056\122\171\165"
	"\344\266\171\376\127\250\160\374\232\034\070\231\260\167\135\107"
	"\153\335\124\124\330\333\152\273\240\155\305\317\300\077\104\244"
	"\365\275\243\114\146\023\110\001\060\201\232\340\370\367\047\144"
	"\325\173\271\256\127\044\152\370\222\057\307\122\157\013\367\144"
	"\311\232\260\060\255\371\061\335\172\313\275\163\303\345\327\231"
	"\141\221\110\271\266\262\261\110\342\171\232\121\205\221\265\116"
	"\053\146\176\331\137\257\267\331\173\165\114\077\132\044\330\273"
	"\266\040\164\154\322\046\264\265\237\116\006\044\340\273\163\014"
	"\041\362\345\201\242\235\132\035\022\247\135\154\314\065\050\202"
	"\126\234\356\051\303\242\336\143\361\344\207\321\240\373\336\302"
	"\355\304\103\220\141\041\161\101\164\131\145\303\040\112\000\253"
	"\164\315\227\073\111\366\110\317\066\147\227\176\031\366\153\117"
	"\026\300\252\324\341\033\026\126\165\174\032"
#define      chk1_z	22
#define      chk1	((&data[359]))
	"\101\073\350\330\001\225\352\263\144\214\223\321\143\212\066\166"
	"\135\061\064\101\163\003\331\141\134\165"
#define      lsto_z	1
#define      lsto	((&data[381]))
	"\147"
#define      opts_z	1
#define      opts	((&data[382]))
	"\034"
#define      date_z	1
#define      date	((&data[383]))
	"\150"
#define      shll_z	10
#define      shll	((&data[385]))
	"\216\015\304\143\231\143\121\371\326\252\001\245\257"
#define      inlo_z	3
#define      inlo	((&data[397]))
	"\057\011\062"
#define      xecc_z	15
#define      xecc	((&data[402]))
	"\311\015\361\103\360\177\306\327\354\216\065\344\203\025\140\241"
	"\002\001\137\324"
#define      msg1_z	65
#define      msg1	((&data[430]))
	"\004\170\205\066\107\104\067\115\151\320\377\101\360\315\305\050"
	"\005\015\234\230\137\220\307\306\265\275\134\367\260\301\010\130"
	"\343\271\273\357\105\047\143\064\107\264\275\004\172\102\215\314"
	"\023\326\035\115\167\157\140\043\370\036\134\266\340\164\250\241"
	"\333\205\257\361\243\215\153\175\360\365\047\320"
#define      rlax_z	1
#define      rlax	((&data[496]))
	"\062"
#define      tst1_z	22
#define      tst1	((&data[497]))
	"\004\366\125\113\370\103\353\165\336\163\331\361\101\175\010\153"
	"\321\114\007\274\232\022\160\200"
#define      chk2_z	19
#define      chk2	((&data[524]))
	"\346\216\036\340\254\124\055\041\177\307\301\105\130\267\266\123"
	"\351\363\334\047\127\123"
#define      tst2_z	19
#define      tst2	((&data[547]))
	"\004\216\002\010\015\042\371\022\256\204\175\171\333\132\376\107"
	"\106\323\072\231\025\122\012\006\207\077\116"
#define      text_z	2035
#define      text	((&data[806]))
	"\065\107\153\336\247\052\026\255\230\206\055\227\113\076\175\331"
	"\135\145\307\120\151\125\122\162\134\331\261\253\245\050\107\332"
	"\157\263\270\027\335\316\304\166\125\361\015\241\060\213\172\216"
	"\360\102\336\132\230\061\315\365\013\177\240\260\247\347\213\027"
	"\232\104\056\170\022\362\356\150\344\373\011\025\207\204\243\167"
	"\306\202\322\137\263\237\124\277\036\364\157\306\334\372\335\166"
	"\077\014\356\121\376\335\272\343\331\303\370\140\107\234\330\016"
	"\036\252\156\322\112\302\221\151\267\001\060\223\374\015\012\073"
	"\031\371\214\030\326\107\373\257\012\364\020\122\220\350\141\256"
	"\223\317\201\336\222\022\110\111\023\170\335\017\206\347\112\240"
	"\341\327\271\267\036\265\147\051\251\167\173\071\140\335\350\364"
	"\254\152\322\076\174\032\210\220\223\145\240\031\115\352\272\056"
	"\302\163\346\341\050\116\012\322\306\206\013\046\143\364\032\020"
	"\136\355\117\333\010\327\153\233\075\014\265\213\367\157\272\271"
	"\343\241\233\013\357\246\335\265\054\351\334\220\236\303\101\240"
	"\154\241\127\371\100\072\277\275\317\203\302\371\024\324\261\136"
	"\262\240\151\323\164\161\102\017\165\116\251\236\332\223\140\360"
	"\160\346\261\231\216\352\012\333\064\155\025\264\115\141\125\040"
	"\051\102\057\307\222\011\346\115\053\316\145\271\011\137\366\073"
	"\242\161\251\076\242\250\076\232\205\062\245\260\107\002\230\020"
	"\013\305\002\202\313\076\020\167\244\166\333\203\226\074\351\146"
	"\140\250\326\323\116\012\160\306\160\133\317\025\143\204\033\036"
	"\174\321\012\037\264\354\015\264\037\251\341\046\312\133\140\073"
	"\266\150\046\020\064\344\261\075\034\130\373\010\064\030\277\147"
	"\050\347\153\161\155\333\206\001\165\332\000\317\312\222\057\030"
	"\370\237\307\036\351\227\264\065\043\126\336\075\010\142\072\170"
	"\335\322\365\310\366\327\236\263\013\374\016\022\376\223\034\121"
	"\172\230\045\241\067\340\122\337\055\363\356\020\201\313\330\167"
	"\346\134\200\235\265\206\262\005\316\103\154\014\163\211\116\170"
	"\025\030\331\015\362\072\017\343\257\305\110\327\253\374\064\022"
	"\221\365\246\355\076\023\313\263\163\133\121\115\302\271\057\156"
	"\043\126\072\262\203\041\075\367\375\376\376\371\150\344\111\035"
	"\230\247\321\067\267\116\133\012\250\146\106\233\313\106\334\037"
	"\230\112\177\066\113\214\051\340\331\053\237\246\277\004\345\361"
	"\134\322\116\245\011\015\023\273\363\155\101\230\137\140\351\174"
	"\343\073\303\000\014\202\120\203\370\225\363\201\217\101\052\373"
	"\132\243\102\166\276\270\143\262\323\002\274\032\041\224\116\334"
	"\124\215\017\345\065\134\041\233\350\273\204\346\204\175\277\045"
	"\227\101\310\367\120\353\325\251\077\043\040\130\104\360\102\371"
	"\236\377\073\265\023\172\220\264\106\332\317\070\073\067\144\362"
	"\027\034\073\062\375\053\015\231\061\361\022\352\306\162\313\355"
	"\324\365\126\047\004\331\027\134\270\321\054\263\251\241\063\301"
	"\321\337\116\156\205\155\273\326\030\167\257\126\317\050\014\151"
	"\255\053\225\372\356\172\135\024\273\267\347\074\346\073\366\073"
	"\161\255\055\215\236\373\206\317\150\117\343\170\352\112\036\353"
	"\304\375\064\071\134\151\365\141\077\220\302\376\302\356\237\236"
	"\343\372\022\260\356\164\277\146\010\265\216\313\053\033\235\072"
	"\274\170\240\013\355\362\145\372\245\273\233\133\346\275\237\322"
	"\060\007\016\014\225\147\047\067\032\327\366\172\112\136\250\150"
	"\121\144\301\376\345\102\344\360\152\233\027\263\270\157\227\072"
	"\344\066\100\367\241\236\261\073\223\072\330\271\166\171\323\212"
	"\156\156\335\255\156\106\300\204\053\257\352\174\301\062\375\145"
	"\273\121\042\112\016\364\203\021\261\262\202\130\051\200\067\352"
	"\157\214\301\015\172\135\233\220\061\016\253\023\360\341\034\231"
	"\347\272\177\113\276\130\027\234\073\114\107\364\060\211\056\201"
	"\142\332\335\271\046\065\170\115\210\251\057\056\323\135\175\056"
	"\236\103\370\140\306\230\234\126\031\373\241\370\377\216\125\016"
	"\374\335\327\374\167\052\203\076\061\145\252\100\103\305\244\025"
	"\032\010\017\146\370\075\223\040\076\331\032\066\331\067\060\176"
	"\201\154\307\337\353\035\132\130\302\045\373\141\216\167\126\211"
	"\106\206\272\326\235\341\124\210\115\140\025\240\100\203\320\314"
	"\010\153\306\026\116\154\146\043\234\252\375\115\313\233\100\205"
	"\202\351\273\353\134\263\242\001\257\022\120\305\144\321\316\112"
	"\246\343\241\356\215\052\345\050\174\157\222\043\353\151\001\202"
	"\116\026\374\351\174\015\151\134\151\126\245\143\330\124\263\022"
	"\307\350\231\307\115\165\063\375\221\057\012\312\312\340\161\267"
	"\357\040\360\246\345\364\073\141\047\051\351\325\206\254\141\131"
	"\126\172\303\266\270\350\222\235\220\141\206\373\242\354\212\320"
	"\225\130\277\133\236\260\074\200\140\077\342\033\174\376\143\215"
	"\015\264\305\276\107\250\244\152\041\331\331\103\373\066\322\003"
	"\272\025\256\052\235\342\004\241\326\207\167\037\357\335\121\104"
	"\006\176\077\173\322\244\073\365\106\276\333\046\202\242\021\115"
	"\040\000\355\127\351\153\100\125\120\172\217\315\004\260\035\156"
	"\362\030\365\326\147\364\151\024\232\032\215\064\072\242\071\244"
	"\136\217\010\272\005\172\201\353\354\240\306\320\136\112\171\030"
	"\344\307\313\261\204\105\146\104\234\253\050\367\342\256\115\173"
	"\055\011\213\270\327\352\151\311\333\371\216\372\123\364\131\052"
	"\206\205\151\351\274\003\047\265\130\116\161\222\227\173\216\002"
	"\135\035\330\101\074\303\355\217\220\034\111\306\361\212\342\072"
	"\032\265\044\342\234\353\270\152\054\360\160\332\063\045\260\152"
	"\013\331\075\034\244\244\005\232\246\206\133\011\005\035\055\012"
	"\246\215\371\066\320\011\243\147\017\267\306\015\044\357\243\164"
	"\075\072\242\171\151\201\041\300\044\313\065\343\276\300\345\145"
	"\124\117\115\222\253\372\103\222\077\162\330\146\172\144\076\013"
	"\002\331\360\024\272\265\361\271\230\061\244\246\044\112\107\004"
	"\314\255\374\257\245\003\372\333\055\272\326\132\025\305\151\264"
	"\161\073\347\312\324\354\325\116\346\200\160\177\203\064\047\363"
	"\310\144\064\122\307\004\053\272\101\360\257\003\145\010\110\120"
	"\264\267\274\206\113\225\263\027\233\163\354\142\301\106\070\043"
	"\322\232\150\245\255\222\000\121\356\134\115\031\342\140\361\020"
	"\261\011\006\277\306\173\200\070\016\024\304\230\043\333\140\062"
	"\026\316\331\142\155\361\147\126\333\222\113\110\052\173\322\353"
	"\377\244\275\367\360\204\276\112\145\122\000\137\356\005\356\231"
	"\117\341\347\115\302\017\267\226\257\277\202\311\313\010\264\142"
	"\362\165\341\110\141\153\250\376\001\236\061\075\153\064\221\200"
	"\120\153\030\161\270\235\330\100\077\274\217\361\157\063\247\331"
	"\206\115\101\065\115\365\376\270\232\312\144\376\067\013\347\261"
	"\242\317\332\112\355\077\114\221\270\035\027\125\365\337\373\266"
	"\316\347\315\277\030\071\051\301\260\160\372\263\051\161\250\366"
	"\172\227\252\217\325\334\345\231\136\065\002\022\011\122\376\010"
	"\045\262\016\033\270\136\166\331\346\173\240\302\136\165\122\373"
	"\205\130\247\207\160\366\054\072\160\140\126\036\250\127\201\266"
	"\327\132\241\077\022\206\220\352\116\360\005\004\166\345\005\216"
	"\263\140\274\123\037\001\255\255\202\071\153\132\020\332\254\222"
	"\247\140\151\170\005\061\323\240\021\203\250\145\010\263\317\205"
	"\146\365\130\146\022\214\071\253\311\105\013\335\123\113\045\116"
	"\073\164\144\275\336\120\255\357\105\063\217\023\304\135\233\131"
	"\204\155\141\065\144\316\303\123\050\275\303\346\115\251\124\236"
	"\025\230\243\046\052\306\174\377\332\017\365\340\317\015\221\377"
	"\170\225\344\163\151\103\262\265\171\145\126\130\154\335\027\207"
	"\220\347\256\123\032\164\216\167\001\127\000\066\047\241\071\323"
	"\342\307\066\307\246\217\301\041\251\166\131\167\107\113\220\366"
	"\000\073\227\274\202\256\164\204\006\002\204\336\224\256\300\236"
	"\243\027\245\300\113\244\325\143\121\170\167\102\214\201\154\230"
	"\066\006\304\316\273\063\166\267\160\355\133\313\350\115\314\257"
	"\216\111\321\152\120\063\264\142\200\006\356\036\117\316\366\126"
	"\051\207\013\030\373\050\147\054\077\111\367\275\307\047\265\100"
	"\111\350\206\325\316\235\125\306\056\203\146\303\244\320\356\075"
	"\134\166\122\150\161\151\006\153\073\107\375\327\257\113\277\213"
	"\137\100\236\211\276\236\351\071\333\224\334\321\271\037\027\311"
	"\136\272\302\036\325\334\230\333\332\005\162\324\035\335\150\342"
	"\041\063\240\205\125\005\234\014\316\037\021\370\040\173\045\172"
	"\151\075\144\271\167\233\257\153\361\330\001\301\073\267\171\273"
	"\357\007\124\047\063\035\020\373\227\115\162\223\205\156\066\166"
	"\367\273\152\334\255\247\277\213\141\031\321\330\016\002\336\075"
	"\370\110\114\024\025\247\311\244\207\041\245\034\267\102\060\322"
	"\352\202\357\314\273\302\012\143\375\332\311\207\007\242\111\134"
	"\072\375\217\310\205\165\067\122\337\133\152\316\010\362\304\357"
	"\231\144\142\110\361\142\327\001\246\232\226\106\256\040\147\313"
	"\203\034\324\322\107\161\074\040\350\203\132\360\352\006\055\115"
	"\010\271\020\047\077\307\250\155\144\042\216\052\223\064\327\034"
	"\305\206\101\114\066\013\366\351\122\156\065\110\003\071\104\365"
	"\234\052\266\156\113\206\132\013\144\071\301\326\133\210\124\041"
	"\210\046\223\116\326\051\231\302\367\367\240\106\005\007\367\252"
	"\267\275\172\107\126\117\017\043\267\020\124\273\261\046\227\034"
	"\231\150\207\176\126\166\043\271\220\321\345\145\035\156\153\244"
	"\103\357\073\315\115\112\055\316\370\234\061\134\011\010\256\052"
	"\374\273\065\363\054\060\363\304\171\300\211\017\174\321\155\272"
	"\273\266\166\275\342\212\153\236\073\023\070\342\020\372\315\244"
	"\107\041\170\110\366\135\174\253\210\140\173\313\156\333\167\250"
	"\224\327\302\202\251\372\131\266\077\066\323\312\057\047\336\030"
	"\053\305\171\137\073\077\351\353\325\332\052\221\070\251\221\336"
	"\366\240\075\344\357\031\354\307\205\207\005\221\074\220\210\254"
	"\113\102\217\354\335\233\333\203\171\221\260\143\155\100\101\144"
	"\341\177\110\320\230\064\230\035\274\235\256\370\056\067\245\171"
	"\171\064\146\126\320\101\331\111\322\211\254\100\312\356\244\253"
	"\155\354\174\006\041\024\043\335\262\322\326\341\011\173\133\202"
	"\257\301\331\200\002\263\311\325\075\165\025\007\143\271\263\321"
	"\246\057\327\307\104\373\244\367\315\172\330\327\366\064\132\246"
	"\365\064\046\370\347\357\316\044\145\343\054\310\235\337\232\104"
	"\017\161\013\123\155\260\112\072\053\043\022\041\127\154\307\115"
	"\240\356\105\210\335\023\255\102\367\331\013\225\271\246\331\310"
	"\027\345\034\205\226\147\277\301\213\322\343\342\077\253\060\340"
	"\231\165\150\167\211\025\272\200\357\305\025\251\154\357\161\204"
	"\324\216\011\152\365\310\054\201\233\017\143\332\273\223\272\124"
	"\011\043\314\222\071\206\023\050\114\051\321\270\030\103\074\354"
	"\322\105\127\310\016\203\111\252\222\255\204\116\101\077\242\112"
	"\142\157\335\233\365\361\304\102\032\226\373\063\332\067\037\254"
	"\175\167\164\214\372\276\066\215\153\273\333\254\372\176\367\135"
	"\355\324\370\343\305\275\045\340\123\041\023\055\131\063\331\326"
	"\252\116\143\244\014\232\062\167\125\015\044\120\213\033\255\171"
	"\360\246\134\266"/* End of data[] */;
#define      hide_z	4096
#define SETUID 0	/* Define as 1 to call setuid(0) at start of script */
#define DEBUGEXEC	0	/* Define as 1 to debug execvp calls */
#define TRACEABLE	1	/* Define as 1 to enable ptrace the executable */
#define HARDENING	0	/* Define as 1 to disable ptrace/dump the executable */
#define HARDENINGSP	0	/* Define as 1 to disable bash child process */
#define BUSYBOXON	0	/* Define as 1 to enable work with busybox */

/* rtc.c */

#include <sys/stat.h>
#include <sys/types.h>

#include <errno.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>
#include <unistd.h>

/* 'Alleged RC4' */

static unsigned char stte[256], indx, jndx, kndx;

/*
 * Reset arc4 stte. 
 */
void stte_0(void)
{
	indx = jndx = kndx = 0;
	do {
		stte[indx] = indx;
	} while (++indx);
}

/*
 * Set key. Can be used more than once. 
 */
void key(void * str, int len)
{
	unsigned char tmp, * ptr = (unsigned char *)str;
	while (len > 0) {
		do {
			tmp = stte[indx];
			kndx += tmp;
			kndx += ptr[(int)indx % len];
			stte[indx] = stte[kndx];
			stte[kndx] = tmp;
		} while (++indx);
		ptr += 256;
		len -= 256;
	}
}

/*
 * Crypt data. 
 */
void arc4(void * str, int len)
{
	unsigned char tmp, * ptr = (unsigned char *)str;
	while (len > 0) {
		indx++;
		tmp = stte[indx];
		jndx += tmp;
		stte[indx] = stte[jndx];
		stte[jndx] = tmp;
		tmp += stte[indx];
		*ptr ^= stte[tmp];
		ptr++;
		len--;
	}
}

/* End of ARC4 */

#if HARDENING

#include <sys/ptrace.h>
#include <sys/wait.h>
#include <signal.h>
#include <sys/prctl.h>
#define PR_SET_PTRACER 0x59616d61

/* Seccomp Sandboxing Init */
#include <stdlib.h>
#include <stdio.h>
#include <stddef.h>
#include <string.h>
#include <unistd.h>
#include <errno.h>

#include <sys/types.h>
#include <sys/prctl.h>
#include <sys/syscall.h>
#include <sys/socket.h>

#include <linux/filter.h>
#include <linux/seccomp.h>
#include <linux/audit.h>

#define ArchField offsetof(struct seccomp_data, arch)

#define Allow(syscall) \
    BPF_JUMP(BPF_JMP+BPF_JEQ+BPF_K, SYS_##syscall, 0, 1), \
    BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW)

struct sock_filter filter[] = {
    /* validate arch */
    BPF_STMT(BPF_LD+BPF_W+BPF_ABS, ArchField),
    BPF_JUMP( BPF_JMP+BPF_JEQ+BPF_K, AUDIT_ARCH_X86_64, 1, 0),
    BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_KILL),

    /* load syscall */
    BPF_STMT(BPF_LD+BPF_W+BPF_ABS, offsetof(struct seccomp_data, nr)),

    /* list of allowed syscalls */
    Allow(exit_group),  /* exits a processs */
    Allow(brk),         /* for malloc(), inside libc */
    Allow(mmap),        /* also for malloc() */
    Allow(munmap),      /* for free(), inside libc */

    /* and if we don't match above, die */
    BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_KILL),
};
struct sock_fprog filterprog = {
    .len = sizeof(filter)/sizeof(filter[0]),
    .filter = filter
};

/* Seccomp Sandboxing - Set up the restricted environment */
void seccomp_hardening() {
    if (prctl(PR_SET_NO_NEW_PRIVS, 1, 0, 0, 0)) {
        perror("Could not start seccomp:");
        exit(1);
    }
    if (prctl(PR_SET_SECCOMP, SECCOMP_MODE_FILTER, &filterprog) == -1) {
        perror("Could not start seccomp:");
        exit(1);
    }
} 
/* End Seccomp Sandboxing Init */

void arc4_hardrun(void * str, int len) {
    //Decode locally
    char tmp2[len];
    memcpy(tmp2, str, len);

	unsigned char tmp, * ptr = (unsigned char *)tmp2;

    int lentmp = len;

#if HARDENINGSP
    //Start tracing to protect from dump & trace
    if (ptrace(PTRACE_TRACEME, 0, 0, 0) < 0) {
        printf("Operation not permitted\n");
        kill(getpid(), SIGKILL);
        exit(1);
    }

    //Decode Bash
    while (len > 0) {
        indx++;
        tmp = stte[indx];
        jndx += tmp;
        stte[indx] = stte[jndx];
        stte[jndx] = tmp;
        tmp += stte[indx];
        *ptr ^= stte[tmp];
        ptr++;
        len--;
    }

    //Exec bash script
    system(tmp2);

    //Empty script variable
    memcpy(tmp2, str, lentmp);

    //Sinal to detach ptrace
    ptrace(PTRACE_DETACH, 0, 0, 0);
    exit(0);

    /* Seccomp Sandboxing - Start */
    seccomp_hardening();

    exit(0);
#endif /* HARDENINGSP Exit here anyway*/

    int pid, status;
    pid = fork();

    if(pid==0) {

        //Start tracing to protect from dump & trace
        if (ptrace(PTRACE_TRACEME, 0, 0, 0) < 0) {
            printf("Operation not permitted\n");
            kill(getpid(), SIGKILL);
            _exit(1);
        }

        //Decode Bash
        while (len > 0) {
            indx++;
            tmp = stte[indx];
            jndx += tmp;
            stte[indx] = stte[jndx];
            stte[jndx] = tmp;
            tmp += stte[indx];
            *ptr ^= stte[tmp];
            ptr++;
            len--;
        }

        //Exec bash script
        system(tmp2);

        //Empty script variable
        memcpy(tmp2, str, lentmp);

        //Sinal to detach ptrace
        ptrace(PTRACE_DETACH, 0, 0, 0);
        exit(0);
    }
    else {
        wait(&status);
    }

    /* Seccomp Sandboxing - Start */
    seccomp_hardening();

    exit(0);
} 
#endif /* HARDENING */

/*
 * Key with file invariants. 
 */
int key_with_file(char * file)
{
	struct stat statf[1];
	struct stat control[1];

	if (stat(file, statf) < 0)
		return -1;

	/* Turn on stable fields */
	memset(control, 0, sizeof(control));
	control->st_ino = statf->st_ino;
	control->st_dev = statf->st_dev;
	control->st_rdev = statf->st_rdev;
	control->st_uid = statf->st_uid;
	control->st_gid = statf->st_gid;
	control->st_size = statf->st_size;
	control->st_mtime = statf->st_mtime;
	control->st_ctime = statf->st_ctime;
	key(control, sizeof(control));
	return 0;
}

#if DEBUGEXEC
void debugexec(char * sh11, int argc, char ** argv)
{
	int i;
	fprintf(stderr, "shll=%s\n", sh11 ? sh11 : "<null>");
	fprintf(stderr, "argc=%d\n", argc);
	if (!argv) {
		fprintf(stderr, "argv=<null>\n");
	} else { 
		for (i = 0; i <= argc ; i++)
			fprintf(stderr, "argv[%d]=%.60s\n", i, argv[i] ? argv[i] : "<null>");
	}
}
#endif /* DEBUGEXEC */

void rmarg(char ** argv, char * arg)
{
	for (; argv && *argv && *argv != arg; argv++);
	for (; argv && *argv; argv++)
		*argv = argv[1];
}

void chkenv_end(void);

int chkenv(int argc)
{
	char buff[512];
	unsigned long mask, m;
	int l, a, c;
	char * string;
	extern char ** environ;

	mask = (unsigned long)getpid();
	stte_0();
	 key(&chkenv, (void*)&chkenv_end - (void*)&chkenv);
	 key(&data, sizeof(data));
	 key(&mask, sizeof(mask));
	arc4(&mask, sizeof(mask));
	sprintf(buff, "x%lx", mask);
	string = getenv(buff);
#if DEBUGEXEC
	fprintf(stderr, "getenv(%s)=%s\n", buff, string ? string : "<null>");
#endif
	l = strlen(buff);
	if (!string) {
		/* 1st */
		sprintf(&buff[l], "=%lu %d", mask, argc);
		putenv(strdup(buff));
		return 0;
	}
	c = sscanf(string, "%lu %d%c", &m, &a, buff);
	if (c == 2 && m == mask) {
		/* 3rd */
		rmarg(environ, &string[-l - 1]);
		return 1 + (argc - a);
	}
	return -1;
}

void chkenv_end(void){}

#if HARDENING

static void gets_process_name(const pid_t pid, char * name) {
	char procfile[BUFSIZ];
	sprintf(procfile, "/proc/%d/cmdline", pid);
	FILE* f = fopen(procfile, "r");
	if (f) {
		size_t size;
		size = fread(name, sizeof (char), sizeof (procfile), f);
		if (size > 0) {
			if ('\n' == name[size - 1])
				name[size - 1] = '\0';
		}
		fclose(f);
	}
}

void hardening() {
    prctl(PR_SET_DUMPABLE, 0);
    prctl(PR_SET_PTRACER, -1);

    int pid = getppid();
    char name[256] = {0};
    gets_process_name(pid, name);

    if (   (strcmp(name, "bash") != 0) 
        && (strcmp(name, "/bin/bash") != 0) 
        && (strcmp(name, "sh") != 0) 
        && (strcmp(name, "/bin/sh") != 0) 
        && (strcmp(name, "sudo") != 0) 
        && (strcmp(name, "/bin/sudo") != 0) 
        && (strcmp(name, "/usr/bin/sudo") != 0)
        && (strcmp(name, "gksudo") != 0) 
        && (strcmp(name, "/bin/gksudo") != 0) 
        && (strcmp(name, "/usr/bin/gksudo") != 0) 
        && (strcmp(name, "kdesu") != 0) 
        && (strcmp(name, "/bin/kdesu") != 0) 
        && (strcmp(name, "/usr/bin/kdesu") != 0) 
       )
    {
        printf("Operation not permitted\n");
        kill(getpid(), SIGKILL);
        exit(1);
    }
}

#endif /* HARDENING */

#if !TRACEABLE

#define _LINUX_SOURCE_COMPAT
#include <sys/ptrace.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <fcntl.h>
#include <signal.h>
#include <stdio.h>
#include <unistd.h>

#if !defined(PT_ATTACHEXC) /* New replacement for PT_ATTACH */
   #if !defined(PTRACE_ATTACH) && defined(PT_ATTACH)
       #define PT_ATTACHEXC	PT_ATTACH
   #elif defined(PTRACE_ATTACH)
       #define PT_ATTACHEXC PTRACE_ATTACH
   #endif
#endif

void untraceable(char * argv0)
{
	char proc[80];
	int pid, mine;

	switch(pid = fork()) {
	case  0:
		pid = getppid();
		/* For problematic SunOS ptrace */
#if defined(__FreeBSD__)
		sprintf(proc, "/proc/%d/mem", (int)pid);
#else
		sprintf(proc, "/proc/%d/as",  (int)pid);
#endif
		close(0);
		mine = !open(proc, O_RDWR|O_EXCL);
		if (!mine && errno != EBUSY)
			mine = !ptrace(PT_ATTACHEXC, pid, 0, 0);
		if (mine) {
			kill(pid, SIGCONT);
		} else {
			perror(argv0);
			kill(pid, SIGKILL);
		}
		_exit(mine);
	case -1:
		break;
	default:
		if (pid == waitpid(pid, 0, 0))
			return;
	}
	perror(argv0);
	_exit(1);
}
#endif /* !TRACEABLE */

char * xsh(int argc, char ** argv)
{
	char * scrpt;
	int ret, i, j;
	char ** varg;
	char * me = argv[0];
	if (me == NULL) { me = getenv("_"); }
	if (me == 0) { fprintf(stderr, "E: neither argv[0] nor $_ works."); exit(1); }

	ret = chkenv(argc);
	stte_0();
	 key(pswd, pswd_z);
	arc4(msg1, msg1_z);
	arc4(date, date_z);
	if (date[0] && (atoll(date)<time(NULL)))
		return msg1;
	arc4(shll, shll_z);
	arc4(inlo, inlo_z);
	arc4(xecc, xecc_z);
	arc4(lsto, lsto_z);
	arc4(tst1, tst1_z);
	 key(tst1, tst1_z);
	arc4(chk1, chk1_z);
	if ((chk1_z != tst1_z) || memcmp(tst1, chk1, tst1_z))
		return tst1;
	arc4(msg2, msg2_z);
	if (ret < 0)
		return msg2;
	varg = (char **)calloc(argc + 10, sizeof(char *));
	if (!varg)
		return 0;
	if (ret) {
		arc4(rlax, rlax_z);
		if (!rlax[0] && key_with_file(shll))
			return shll;
		arc4(opts, opts_z);
#if HARDENING
	    arc4_hardrun(text, text_z);
	    exit(0);
       /* Seccomp Sandboxing - Start */
       seccomp_hardening();
#endif
		arc4(text, text_z);
		arc4(tst2, tst2_z);
		 key(tst2, tst2_z);
		arc4(chk2, chk2_z);
		if ((chk2_z != tst2_z) || memcmp(tst2, chk2, tst2_z))
			return tst2;
		/* Prepend hide_z spaces to script text to hide it. */
		scrpt = malloc(hide_z + text_z);
		if (!scrpt)
			return 0;
		memset(scrpt, (int) ' ', hide_z);
		memcpy(&scrpt[hide_z], text, text_z);
	} else {			/* Reexecute */
		if (*xecc) {
			scrpt = malloc(512);
			if (!scrpt)
				return 0;
			sprintf(scrpt, xecc, me);
		} else {
			scrpt = me;
		}
	}
	j = 0;
#if BUSYBOXON
	varg[j++] = "busybox";
	varg[j++] = "sh";
#else
	varg[j++] = argv[0];		/* My own name at execution */
#endif
	if (ret && *opts)
		varg[j++] = opts;	/* Options on 1st line of code */
	if (*inlo)
		varg[j++] = inlo;	/* Option introducing inline code */
	varg[j++] = scrpt;		/* The script itself */
	if (*lsto)
		varg[j++] = lsto;	/* Option meaning last option */
	i = (ret > 1) ? ret : 0;	/* Args numbering correction */
	while (i < argc)
		varg[j++] = argv[i++];	/* Main run-time arguments */
	varg[j] = 0;			/* NULL terminated array */
#if DEBUGEXEC
	debugexec(shll, j, varg);
#endif
	execvp(shll, varg);
	return shll;
}

int main(int argc, char ** argv)
{
#if SETUID
   setuid(0);
#endif
#if DEBUGEXEC
	debugexec("main", argc, argv);
#endif
#if HARDENING
	hardening();
#endif
#if !TRACEABLE
	untraceable(argv[0]);
#endif
	argv[1] = xsh(argc, argv);
	fprintf(stderr, "%s%s%s: %s\n", argv[0],
		errno ? ": " : "",
		errno ? strerror(errno) : "",
		argv[1] ? argv[1] : "<null>"
	);
	return 1;
}
